@model ClbTinhoc.Web.Models.KhoaHoc
@using Microsoft.AspNetCore.Authorization
@inject IAuthorizationService AuthorizationService

@{
    ViewData["Title"] = "Chi tiết khóa học";
}

<h1>Chi tiết khóa học</h1>

<div>
    <hr />
    <div class="row">
        <div class="col-md-4">
            <img src="~/images/@Model.image" class="img-fluid rounded" alt="@Model.TenKhoaHoc"
                 onerror="this.src='/images/default-course.png'" />
        </div>
        <div class="col-md-8">
            <dl class="row">
                <dt class="col-sm-3">Tên khóa học</dt>
                <dd class="col-sm-9">@Html.DisplayFor(model => model.TenKhoaHoc)</dd>

                <dt class="col-sm-3">Mô tả</dt>
                <dd class="col-sm-9">@Html.DisplayFor(model => model.MoTa)</dd>

                <dt class="col-sm-3">Ngày bắt đầu</dt>
                <dd class="col-sm-9">@Model.NgayBatDau.ToString("dd/MM/yyyy")</dd>

                <dt class="col-sm-3">Ngày kết thúc</dt>
                <dd class="col-sm-9">@Model.NgayKetThuc.ToString("dd/MM/yyyy")</dd>
            </dl>
            <!-- Nút đăng ký khóa học -->
            <div class="mt-3">
                <button id="registerCourseBtn" class="btn btn-primary">Đăng ký sinh viên</button>
                <button id="registerSupportBtn" class="btn btn-info">Đăng ký support</button>
            </div>
            <div id="registerCourseForm" class="mt-3" style="display:none;">
                <form asp-action="RegisterCourse" asp-controller="KhoaHoc" method="post">
                    <input type="hidden" name="MaKhoaHoc" value="@Model.MaKhoaHoc" />
                    <div class="form-group">
                        <label for="MaSinhVien">Chọn sinh viên</label>
                        <div class="input-group">
                            <select name="MaSinhVien" id="MaSinhVien" class="form-control select2" required>
                                <option value="">-- Chọn sinh viên --</option>
                                @if (ViewBag.AvailableStudents != null && ViewBag.AvailableStudents.Count > 0)
                                {
                                    @foreach (var student in ViewBag.AvailableStudents)
                                    {
                                        <option value="@student.MaSinhVien">@student.HoTen (@student.MaSinhVien)</option>
                                    }
                                }
                            </select>
                            <button type="button" class="btn btn-outline-secondary"
                                    onclick="$('#MaSinhVien').select2('open');">
                                <i class="bi bi-caret-down-fill"></i>
                            </button>
                        </div>
                        @if (ViewBag.AvailableStudents == null || ViewBag.AvailableStudents.Count == 0)
                        {
                            <small class="text-danger">Không có sinh viên nào khả dụng</small>
                        }
                    </div>
                    <div class="form-group mt-3">
                        <button type="submit" class="btn btn-success">Xác nhận đăng ký</button>
                        <button type="button" id="cancelRegisterCourse" class="btn btn-secondary">Hủy</button>
                    </div>
                </form>
            </div>
            <div id="registerSupportForm" class="mt-3" style="display:none;">
                <form asp-action="RegisterSupport" asp-controller="KhoaHoc" method="post">
                    <input type="hidden" name="MaKhoaHoc" value="@Model.MaKhoaHoc" />
                    <div class="form-group">
                        <label for="MaSupport">Chọn support</label>
                        <div class="input-group">
                            <select name="MaSupport" id="MaSupport" class="form-control select2" required>
                                <option value="">-- Chọn support --</option>
                                @if (ViewBag.AvailableSupports != null && ViewBag.AvailableSupports.Count > 0)
                                {
                                    @foreach (var support in ViewBag.AvailableSupports)
                                    {
                                        <option value="@support.MaSupport">@support.HoTen (@support.MaSupport)</option>
                                    }
                                }
                            </select>
                            <button type="button" class="btn btn-outline-secondary"
                                    onclick="$('#MaSupport').select2('open');">
                                <i class="bi bi-caret-down-fill"></i>
                            </button>
                        </div>
                        @if (ViewBag.AvailableSupports == null || ViewBag.AvailableSupports.Count == 0)
                        {
                            <small class="text-danger">Không có support nào khả dụng</small>
                        }
                    </div>
                    <div class="form-group mt-3">
                        <button type="submit" class="btn btn-success">Xác nhận đăng ký</button>
                        <button type="button" id="cancelRegisterSupport" class="btn btn-secondary">Hủy</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <h3 class="mt-4">Danh sách sinh viên tham gia</h3>
    @if (Model.KhoaHoc_SinhVien != null && Model.KhoaHoc_SinhVien.Any())
    {
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Mã sinh viên</th>
                    <th>Họ tên</th>
                    <th>Lớp sinh hoạt</th>
                    <th>Email</th>
                    <th>Thao tác</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var ks in Model.KhoaHoc_SinhVien)
                {
                    <tr>
                        <td>@ks.MaSinhVien</td>
                        <td>@(ks.SinhVien?.HoTen ?? "Không tìm thấy")</td>
                        <td>@(ks.SinhVien?.LopSinhHoat ?? "Không tìm thấy")</td>
                        <td>@(ks.SinhVien?.Email ?? "Không tìm thấy")</td>
                        <td>
                            <a asp-controller="SinhVien" asp-action="Details" asp-route-id="@ks.MaSinhVien"
                               class="btn btn-sm btn-info">Chi tiết</a>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    }
    else
    {
        <p>Chưa có sinh viên nào tham gia khóa học này.</p>
    }

    <h3 class="mt-4">Danh sách support</h3>
    @if (Model.SupportKhoaHoc != null && Model.SupportKhoaHoc.Any())
    {
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Mã support</th>
                    <th>Họ tên</th>
                    <th>Email</th>
                    <th>Số điện thoại</th>
                    <th>Lớp sinh hoạt</th>
                    <th>Thao tác</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var ks in Model.SupportKhoaHoc)
                {
                    <tr>
                        <td>@ks.MaSupport</td>
                        <td>@(ks.Support?.HoTen ?? "Không tìm thấy")</td>
                        <td>@(ks.Support?.Email ?? "Không tìm thấy")</td>
                        <td>@(ks.Support?.SoDienThoai ?? "Không tìm thấy")</td>
                        <td>@(ks.Support?.LopSinhHoat ?? "Không tìm thấy")</td>
                        <td>
                            <a asp-controller="Support" asp-action="Details" asp-route-id="@ks.MaSupport"
                               class="btn btn-sm btn-info">Chi tiết</a>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    }
    else
    {
        <p>Chưa có support nào cho khóa học này.</p>
    }
</div>

<div class="mt-3">
    <a asp-action="Index" class="btn btn-secondary">Quay lại danh sách</a>
</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet" />

    <script>
        $(document).ready(function () {
            // Khởi tạo Select2 cho sinh viên
            $('#MaSinhVien').select2({
                placeholder: "-- Chọn sinh viên --",
                allowClear: true,
                width: '100%',
                dropdownParent: $('#registerCourseForm')
            });

            // Khởi tạo Select2 cho support
            $('#MaSupport').select2({
                placeholder: "-- Chọn support --",
                allowClear: true,
                width: '100%',
                dropdownParent: $('#registerSupportForm')
            });

            // Hiển thị/ẩn form đăng ký sinh viên
            $('#registerCourseBtn').click(function () {
                $('#registerCourseForm').show();
                $('#registerSupportForm').hide();
            });

            $('#cancelRegisterCourse').click(function () {
                $('#registerCourseForm').hide();
                $('#MaSinhVien').val('').trigger('change');
            });

            // Hiển thị/ẩn form đăng ký support
            $('#registerSupportBtn').click(function () {
                $('#registerSupportForm').show();
                $('#registerCourseForm').hide();
            });

            $('#cancelRegisterSupport').click(function () {
                $('#registerSupportForm').hide();
                $('#MaSupport').val('').trigger('change');
            });
        });
    </script>
}